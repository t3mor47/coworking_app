<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Unirse a la cola / Join Queue</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: 50px auto; }
        label { display: block; margin-top: 15px; }
        input { width: 100%; padding: 8px; margin-top: 5px; }
        button { margin-top: 15px; padding: 10px 20px; }
        p { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <h1 id="title">Unirse a la cola / Join Queue</h1>

    <label for="language">Idioma / Language:</label>
    <select id="language">
        <option value="es">ES</option>
        <option value="en">EN</option>
    </select>

    <form id="queueForm">
        <label id="labelName">Nombre / Apodo:</label>
        <input type="text" id="name" required>

        <label id="labelCode">Código del club / Club Code:</label>
        <input type="text" id="club_code" required>

        <button type="submit" id="joinBtn">Unirse a la cola / Join Queue</button>
    </form>

    <p id="position"></p>
    <p id="message"></p>

    <script>
        const form = document.getElementById('queueForm');
        const positionEl = document.getElementById('position');
        const messageEl = document.getElementById('message');
        const languageSelect = document.getElementById('language');
        const joinBtn = document.getElementById('joinBtn');
        const nameInput = document.getElementById('name');
        const codeInput = document.getElementById('club_code');

        // --- Переводы ---
        function setLanguage() {
            const lang = languageSelect.value;
            if (lang === 'es') {
                document.getElementById('title').innerText = "Unirse a la cola";
                document.getElementById('labelName').innerText = "Nombre / Apodo:";
                document.getElementById('labelCode').innerText = "Código del club:";
                joinBtn.innerText = "Unirse a la cola";
            } else {
                document.getElementById('title').innerText = "Join Queue";
                document.getElementById('labelName').innerText = "Name / Nickname:";
                document.getElementById('labelCode').innerText = "Club Code:";
                joinBtn.innerText = "Join Queue";
            }
        }
        languageSelect.addEventListener('change', setLanguage);
        setLanguage();

        // --- Генерация и сохранение уникального device_id ---
        function getDeviceId() {
            let id = localStorage.getItem('device_id');
            if (!id) {
                id = 'dev-' + Math.random().toString(36).substring(2, 12);
                localStorage.setItem('device_id', id);
            }
            return id;
        }
        const deviceId = getDeviceId();

        // --- Проверка статуса при загрузке ---
        async function checkStatus() {
            try {
                const resp = await fetch(`/api/status/${deviceId}`);
                const data = await resp.json();
                if (data.in_queue) {
                    showInQueueState(data.position);
                } else {
                    resetFormState();
                }
            } catch (err) {
                console.error("Status check failed:", err);
            }
        }

        // --- Показ состояния, если пользователь уже в очереди ---
        function showInQueueState(position) {
            const lang = languageSelect.value;
            positionEl.innerText = (lang === 'es' ? 'Tu posición: ' : 'Your position: ') + position;
            messageEl.innerText = '';
            joinBtn.disabled = true;
            nameInput.disabled = true;
            codeInput.disabled = true;
        }

        // --- Возврат в начальное состояние ---
        function resetFormState() {
            joinBtn.disabled = false;
            nameInput.disabled = false;
            codeInput.disabled = false;
            positionEl.innerText = '';
            messageEl.innerText = '';
        }

        // --- Автообновление позиции ---
        async function updatePosition() {
            try {
                const resp = await fetch(`/api/status/${deviceId}`);
                const data = await resp.json();
                if (data.in_queue) {
                    showInQueueState(data.position);
                } else {
                    resetFormState();
                }
            } catch (err) {
                console.error("Update failed:", err);
            }
        }
        setInterval(updatePosition, 10000); // каждые 10 сек

        // --- Обработка формы ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            const code = codeInput.value.trim();
            const lang = languageSelect.value;

            if (!name || !code) {
                alert(lang === 'es' ? "Por favor, ingresa tu nombre y código." : "Please enter your name and code.");
                return;
            }

            try {
                const resp = await fetch('/api/join', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, code, device_id: deviceId})
                });

                if (resp.status === 403) {
                    const text = lang === 'es'
                        ? "La cola está cerrada. Horario: 11:00–23:00."
                        : "The queue is closed. Hours: 11:00–23:00.";
                    alert(text);
                    return;
                }

                const data = await resp.json();

                if (data.error) {
                    alert(lang === 'es' ? "Error: " + data.error : "Error: " + data.error);
                    return;
                }

                showInQueueState(data.position);
                localStorage.setItem('name', name);
                localStorage.setItem('club_code', code);
            } catch (err) {
                console.error("Join error:", err);
            }
        });

        // --- Запуск при загрузке страницы ---
        checkStatus();
    </script>
</body>
</html>
