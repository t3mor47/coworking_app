<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Queue / Cola</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 500px; margin: 50px auto; }
    label { display: block; margin-top: 15px; }
    input { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 20px; }
    p { margin-top: 20px; font-weight: bold; }
    select { padding: 6px; font-size: 15px; }
    option { padding: 4px; }
  </style>
</head>
<body>
  <h1 id="title"></h1>

  <label for="language">ğŸŒ</label>
  <select id="language">
    <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
    <option value="en">ğŸ‡¬ğŸ‡§ English</option>
    <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
    <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
    <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
    <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
    <option value="uk">ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</option>
  </select>

  <form id="queueForm">
    <label id="labelName"></label>
    <input type="text" id="name" required>

    <label id="labelCode"></label>
    <input type="text" id="club_code" required>

    <button type="submit" id="joinBtn"></button>
  </form>

  <p id="position"></p>
  <p id="message"></p>

  <script>
    const form = document.getElementById('queueForm');
    const positionEl = document.getElementById('position');
    const messageEl = document.getElementById('message');
    const languageSelect = document.getElementById('language');
    const joinBtn = document.getElementById('joinBtn');
    const nameInput = document.getElementById('name');
    const codeInput = document.getElementById('club_code');

    const texts = {
      es: { title: "Unirse a la cola", name: "Nombre / Apodo:", code: "CÃ³digo del club:", join: "Unirse a la cola", pos: "Tu posiciÃ³n: ", error: "Por favor, ingresa tu nombre y cÃ³digo.", closed: "La cola estÃ¡ cerrada. Horario: 11:00â€“23:00." },
      en: { title: "Join the Queue", name: "Name / Nickname:", code: "Club Code:", join: "Join Queue", pos: "Your position: ", error: "Please enter your name and code.", closed: "The queue is closed. Hours: 11:00â€“23:00." },
      ar: { title: "Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±", name: "Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù„Ù‚Ø¨:", code: "Ø±Ù…Ø² Ø§Ù„Ù†Ø§Ø¯ÙŠ:", join: "Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±", pos: "Ù…ÙˆÙ‚Ø¹Ùƒ: ", error: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù…Ø².", closed: "Ø§Ù„Ø·Ø§Ø¨ÙˆØ± Ù…ØºÙ„Ù‚. Ø§Ù„Ø³Ø§Ø¹Ø§Øª: 11:00â€“23:00." },
      it: { title: "Unisciti alla coda", name: "Nome / Soprannome:", code: "Codice del club:", join: "Unisciti alla coda", pos: "La tua posizione: ", error: "Inserisci nome e codice.", closed: "La coda Ã¨ chiusa. Orario: 11:00â€“23:00." },
      fr: { title: "Rejoindre la file", name: "Nom / Surnom:", code: "Code du club:", join: "Rejoindre", pos: "Votre position: ", error: "Veuillez entrer votre nom et code.", closed: "La file est fermÃ©e. Horaires: 11:00â€“23:00." },
      de: { title: "Der Warteschlange beitreten", name: "Name / Spitzname:", code: "Club-Code:", join: "Beitreten", pos: "Deine Position: ", error: "Bitte Name und Code eingeben.", closed: "Die Warteschlange ist geschlossen. Zeiten: 11:00â€“23:00." },
      ru: { title: "Ğ’ÑÑ‚Ğ°Ñ‚ÑŒ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ", name: "Ğ˜Ğ¼Ñ / ĞĞ¸Ğº:", code: "ĞšĞ¾Ğ´ ĞºĞ»ÑƒĞ±Ğ°:", join: "Ğ’ÑÑ‚Ğ°Ñ‚ÑŒ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ", pos: "Ğ’Ğ°ÑˆĞ° Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ: ", error: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ¸ ĞºĞ¾Ğ´.", closed: "ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ°. Ğ’Ñ€ĞµĞ¼Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹: 11:00â€“23:00." },
      uk: { title: "ĞŸÑ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ñ‚Ğ¸ÑÑ Ğ´Ğ¾ Ñ‡ĞµÑ€Ğ³Ğ¸", name: "Ğ†Ğ¼'Ñ / ĞŸÑ€Ñ–Ğ·Ğ²Ğ¸ÑÑŒĞºĞ¾:", code: "ĞšĞ¾Ğ´ ĞºĞ»ÑƒĞ±Ñƒ:", join: "ĞŸÑ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ñ‚Ğ¸ÑÑ", pos: "Ğ’Ğ°ÑˆĞ° Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ: ", error: "Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ñ–Ğ¼'Ñ Ñ‚Ğ° ĞºĞ¾Ğ´.", closed: "Ğ§ĞµÑ€Ğ³Ğ° Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ğ°. Ğ“Ğ¾Ğ´Ğ¸Ğ½Ğ¸: 11:00â€“23:00." }
    };

    function setLanguage() {
      const lang = languageSelect.value;
      document.getElementById('title').innerText = texts[lang].title;
      document.getElementById('labelName').innerText = texts[lang].name;
      document.getElementById('labelCode').innerText = texts[lang].code;
      joinBtn.innerText = texts[lang].join;
      updatePosition();
    }
    languageSelect.addEventListener('change', setLanguage);
    setLanguage();

    function getDeviceId() {
      let id = localStorage.getItem('device_id');
      if (!id) {
        id = 'dev-' + Math.random().toString(36).substring(2, 12);
        localStorage.setItem('device_id', id);
      }
      return id;
    }
    const deviceId = getDeviceId();

    async function checkStatus() {
      try {
        const resp = await fetch(`/api/status/${deviceId}`);
        const data = await resp.json();
        if (data.in_queue) showInQueueState(data.position);
        else resetFormState();
      } catch (err) { console.error("Status check failed:", err); }
    }

    function showInQueueState(position) {
      const lang = languageSelect.value;
      positionEl.innerText = texts[lang].pos + position;
      messageEl.innerText = '';
      joinBtn.disabled = true;
      nameInput.disabled = true;
      codeInput.disabled = true;
    }

    function resetFormState() {
      joinBtn.disabled = false;
      nameInput.disabled = false;
      codeInput.disabled = false;
      positionEl.innerText = '';
      messageEl.innerText = '';
    }

    async function updatePosition() {
      try {
        const resp = await fetch(`/api/status/${deviceId}`);
        const data = await resp.json();
        if (data.in_queue) showInQueueState(data.position);
        else resetFormState();
      } catch (err) { console.error("Update failed:", err); }
    }
    setInterval(updatePosition, 10000);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const code = codeInput.value.trim();
      const lang = languageSelect.value;

      if (!name || !code) {
        alert(texts[lang].error);
        return;
      }

      try {
        const resp = await fetch('/api/join', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name, code, device_id: deviceId })
        });

        if (resp.status === 403) {
          alert(texts[lang].closed);
          return;
        }

        const data = await resp.json();
        if (data.error) {
          alert("Error: " + data.error);
          return;
        }

        showInQueueState(data.position);
        localStorage.setItem('name', name);
        localStorage.setItem('club_code', code);
      } catch (err) {
        console.error("Join error:", err);
      }
    });

    checkStatus();
  </script>
</body>
</html>
